<div class="meet-scheduling-tool">
  <!-- Header -->
  <div class="tool-header">
    <button class="btn-back" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Volver
    </button>
    <h1>Gestión de Citas</h1>
  </div>

  <!-- Messages -->
  @if (error()) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>{{ error() }}</span>
      <button class="close-btn" (click)="error.set(null)">×</button>
    </div>
  }

  @if (successMessage()) {
    <div class="alert alert-success">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>{{ successMessage() }}</span>
      <button class="close-btn" (click)="successMessage.set(null)">×</button>
    </div>
  }

  <!-- Tabs -->
  <div class="tabs">
    <button
      class="tab-btn"
      [class.active]="activeTab() === 'book'"
      (click)="switchTab('book')"
    >
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      Agendar Cita
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab() === 'appointments'"
      (click)="switchTab('appointments')"
    >
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
      </svg>
      Mis Citas
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Book Appointment Tab -->
    @if (activeTab() === 'book') {
      <div class="booking-layout">
        <!-- Calendar Section (Left) -->
        <div class="calendar-section">
          <div class="section-card">
            <h2>Selecciona una Fecha</h2>
            
            <div class="calendar-container">
              <!-- Calendar Header -->
              <div class="calendar-header">
                <button class="btn-nav" (click)="previousMonth()" [disabled]="loading()">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <h3>{{ getCurrentMonthName() }}</h3>
                <button class="btn-nav" (click)="nextMonth()" [disabled]="loading()">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </button>
              </div>

              @if (loading()) {
                <div class="calendar-loading">
                  <div class="spinner"></div>
                  <p>Cargando disponibilidad...</p>
                </div>
              } @else {
                <!-- Week Days -->
                <div class="calendar-weekdays">
                  @for (day of weekDays; track day) {
                    <div class="weekday">{{ day }}</div>
                  }
                </div>

                <!-- Calendar Days -->
                <div class="calendar-days">
                  @for (day of calendarDays(); track day.dateStr) {
                    <button
                      class="calendar-day"
                      [class.other-month]="!day.isCurrentMonth"
                      [class.today]="day.isToday"
                      [class.has-availability]="day.hasAvailability"
                      [class.selected]="selectedDate() === day.dateStr"
                      [class.past]="day.isPast"
                      [disabled]="!day.hasAvailability || day.isPast || !day.isCurrentMonth"
                      (click)="onDaySelected(day)"
                    >
                      <span class="day-number">{{ day.date.getDate() }}</span>
                      @if (day.hasAvailability && !day.isPast) {
                        <span class="availability-dot"></span>
                      }
                    </button>
                  }
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Time Slots Section (Right) -->
        <div class="slots-section-container">
          <div class="section-card">
            <h2>Horarios Disponibles</h2>
            
            @if (!selectedDate()) {
              <div class="no-selection">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p>Selecciona una fecha del calendario</p>
              </div>
            } @else {
              @if (hasSlots()) {
                <div class="slots-grid">
                  @for (slot of availableSlots(); track slot.start) {
                    <button
                      class="slot-btn"
                      [class.selected]="selectedSlot() === slot"
                      (click)="selectSlot(slot)"
                      [disabled]="loading()"
                    >
                      {{ formatTime(slot.start) }} - {{ formatTime(slot.end) }}
                    </button>
                  }
                </div>

                @if (selectedSlot()) {
                  <button
                    class="btn-book"
                    (click)="bookAppointment()"
                    [disabled]="loading()"
                  >
                    @if (loading()) {
                      <span class="spinner"></span>
                      Agendando...
                    } @else {
                      Confirmar Cita
                    }
                  </button>
                }
              } @else {
                <div class="no-slots">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <p>No hay horarios disponibles para esta fecha</p>
                </div>
              }
            }
          </div>
        </div>
      </div>
    }

    <!-- My Appointments Tab -->
    @if (activeTab() === 'appointments') {
      <div class="appointments-container">
        <div class="section-card">
          <h2>Mis Citas Agendadas</h2>

          @if (userAppointments().length > 0) {
            <div class="appointments-list">
              @for (appointment of userAppointments(); track appointment.name) {
                <div class="appointment-card" [class]="getStatusClass(appointment.status)">
                  <div class="appointment-header">
                    <div class="appointment-date">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span>{{ formatDate(appointment.start_datetime) }}</span>
                    </div>
                    <span class="status-badge" [class]="getStatusClass(appointment.status)">
                      {{ appointment.status }}
                    </span>
                  </div>

                  <div class="appointment-time">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>{{ formatTime(appointment.start_datetime) }} - {{ formatTime(appointment.end_datetime) }}</span>
                  </div>

                  @if (appointment.meeting_url) {
                    <div class="appointment-link">
                      <a [href]="appointment.meeting_url" target="_blank" rel="noopener noreferrer">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        Unirse a la reunión
                      </a>
                    </div>
                  }

                  @if (appointment.status === 'Confirmed' || appointment.status === 'Draft') {
                    <button class="btn-cancel" (click)="cancelAppointment(appointment)">
                      Cancelar Cita
                    </button>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="no-appointments">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p>No tienes citas agendadas</p>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>

<!-- Pre-Confirmation Modal -->
@if (showPreConfirmModal()) {
  <div class="modal-overlay">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <div class="modal-icon info">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <h2>Confirmar Cita</h2>
        <p>Revisa los detalles de tu cita antes de confirmar</p>
      </div>

      @if (selectedSlot()) {
        <div class="modal-body modal-body-two-columns">
          <div class="appointment-info-column">
            <h3 class="column-title">Detalles de la Cita</h3>
            <div class="appointment-details">
              <div class="detail-row">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <div>
                  <span class="label">Fecha</span>
                  <span class="value">{{ formatDate(selectedSlot()!.start) }}</span>
                </div>
              </div>

              <div class="detail-row">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                  <span class="label">Horario</span>
                  <span class="value">{{ formatTime(selectedSlot()!.start) }} - {{ formatTime(selectedSlot()!.end) }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="context-column">
            <div class="context-section">
              <label for="appointment-context">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                Contexto de la Cita (Opcional)
              </label>
              <p class="context-hint">Agrega detalles sobre el motivo de la cita. Puedes escribir o usar el dictado por voz.</p>
              <textarea
                id="appointment-context"
                class="context-textarea"
                placeholder="Ejemplo: Consulta sobre contratos laborales, necesito asesoría para revisar una cláusula específica..."
                rows="4"
                [ngModel]="appointmentContext()"
                (ngModelChange)="appointmentContext.set($event)"
                [disabled]="loading()"
              ></textarea>

              <div style="margin-top: 0.75rem;">
                <app-voice-input
                  [language]="'es-ES'"
                  [continuous]="true"
                  [interimResults]="true"
                  [buttonLabel]="'Dictar por voz'"
                  (transcriptChange)="appointmentContext.set($event)"
                ></app-voice-input>
              </div>
            </div>
          </div>
        </div>
      }

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closePreConfirmModal()" [disabled]="loading()">
          Cancelar
        </button>
        <button class="btn-primary" (click)="confirmBooking()" [disabled]="loading()">
          @if (loading()) {
            <span class="spinner"></span>
            Confirmando...
          } @else {
            Confirmar Cita
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Confirmation Modal -->
@if (showConfirmModal()) {
  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon success">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h2>¡Cita Agendada Exitosamente!</h2>
        <p>Tu cita ha sido confirmada</p>
      </div>

      @if (confirmedAppointment()) {
        <div class="modal-body">
          <div class="appointment-details">
            <div class="detail-row">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <div>
                <span class="label">Fecha</span>
                <span class="value">{{ formatDate(confirmedAppointment()!.start_datetime) }}</span>
              </div>
            </div>

            <div class="detail-row">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                <span class="label">Horario</span>
                <span class="value">{{ formatTime(confirmedAppointment()!.start_datetime) }} - {{ formatTime(confirmedAppointment()!.end_datetime) }}</span>
              </div>
            </div>

            @if (confirmedAppointment()!.meeting_url) {
              <div class="detail-row">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <div>
                  <span class="label">Link de reunión</span>
                  <a [href]="confirmedAppointment()!.meeting_url" target="_blank" rel="noopener noreferrer" class="meeting-link">
                    Unirse a la reunión →
                  </a>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeConfirmModal()">
          Agendar otra cita
        </button>
        <button class="btn-primary" (click)="viewAppointments()">
          Ver mis citas
        </button>
      </div>
    </div>
  </div>
}
