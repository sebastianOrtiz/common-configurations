import{Ca as v,Da as u,Ea as T,c as d,d as m,e as g,i as c,k as f,q as y,t as b}from"./chunk-T6CG4JNB.js";var A={authorizationMode:"csrf-token"},o=new Map,_=class h{constructor(e){this.http=e;this.loadConfig()}config=A;loadConfig(){let e=localStorage.getItem("frappe_api_token");e&&(this.config.authorizationMode="api-token",this.config.token=e)}getAuthHeaders(){let e=new v({"Content-Type":"application/json",Accept:"application/json"});if(this.config.authorizationMode==="api-token"&&this.config.token)e=e.set("Authorization",`Basic ${this.config.token}`);else{let t=this.getCsrfToken();t&&(e=e.set("X-Frappe-CSRF-Token",t))}return e}getCsrfToken(){let e=window.frappe;if(e&&e.csrf_token)return e.csrf_token;let t=window.csrf_token;if(t)return t;let r=document.cookie.split(";");for(let s of r){let[n,i]=s.trim().split("=");if(n==="csrf_token")return decodeURIComponent(i)}return""}fetchCsrfToken(){return d(fetch("/api/method/common_configurations.api.portal_api.get_csrf_token",{method:"GET",credentials:"same-origin",headers:{Accept:"application/json"}}).then(e=>e.json()).then(e=>{if(e&&e.message){let t=e.message;return window.frappe||(window.frappe={}),window.frappe.csrf_token=t,t}return""}).catch(()=>""))}getCacheKey(e,t,r){let s=r?JSON.stringify(r):"";return`${e}:${t}:${s}`}extractServerMessage(e){if(e._server_messages)try{let t=JSON.parse(e._server_messages);if(Array.isArray(t)&&t.length>0)return JSON.parse(t[0]).message}catch{}}get(e,t,r=!1){let s=new u;t&&Object.keys(t).forEach(p=>{t[p]!==null&&t[p]!==void 0&&(s=s.set(p,String(t[p])))});let n=this.buildUrl(e),i=s.toString()?`${n}?${s.toString()}`:n,a=this.getCacheKey("GET",i);if(!r&&o.has(a))return o.get(a);let l=this.http.get(n,{headers:this.getAuthHeaders(),params:s}).pipe(g(p=>this.normalizeResponse(p)),c(p=>this.handleError(p)),f(1));return r||(o.set(a,l),l.subscribe({complete:()=>o.delete(a),error:()=>o.delete(a)})),l}post(e,t,r=!1){let s=this.buildUrl(e),n=this.getCacheKey("POST",s,t);if(!r&&o.has(n))return o.get(n);let i=this.http.post(s,t,{headers:this.getAuthHeaders()}).pipe(g(a=>this.normalizeResponse(a)),c(a=>this.handleError(a)),f(1));return r||(o.set(n,i),i.subscribe({complete:()=>o.delete(n),error:()=>o.delete(n)})),i}put(e,t){let r=this.buildUrl(e);return this.http.put(r,t,{headers:this.getAuthHeaders()}).pipe(g(s=>this.normalizeResponse(s)),c(s=>this.handleError(s)))}delete(e){let t=this.buildUrl(e);return this.http.delete(t,{headers:this.getAuthHeaders()}).pipe(g(r=>this.normalizeResponse(r)),c(r=>this.handleError(r)))}callMethod(e,t,r=!1){let s=`/api/method/${e}`;return r?this.get(s,t,!0):this.post(s,t,!0)}getDoc(e,t){return this.get(`/api/resource/${e}/${t}`)}getList(e,t,r,s=0,n=20){let i={};return t&&(i.filters=JSON.stringify(t)),r&&r.length&&(i.fields=JSON.stringify(r)),i.limit_start=s,i.limit_page_length=n,this.get(`/api/resource/${e}`,i)}createDoc(e,t){return this.post(`/api/resource/${e}`,t,!0)}updateDoc(e,t,r){return this.put(`/api/resource/${e}/${t}`,r)}deleteDoc(e,t){return this.delete(`/api/resource/${e}/${t}`)}login(e,t){return this.post("/api/method/login",{usr:e,pwd:t},!0)}logout(){return this.post("/api/method/logout",{},!0)}getCurrentUser(){return this.get("/api/method/frappe.auth.get_logged_user")}buildUrl(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/")?e:`/${e}`}normalizeResponse(e){let t={success:!e.exc&&!e.error,message:e.message,data:e.message||e.data};if(!t.success&&e._server_messages){let r=this.extractServerMessage(e);r&&(t.error=r)}return e.exc&&(t.error=e.exc,t.exc=e.exc),e.error_code&&(t.error_code=e.error_code),t}handleError(e){console.error("[Frappe API Error]",e);let t={success:!1,error:e.error?.message||e.message||"Unknown error occurred"};if(e.error){if(e.error._server_messages){let r=this.extractServerMessage(e.error);r&&(t.error=r)}e.error.exc&&(t.exc=e.error.exc)}return m(t)}setApiToken(e){this.config.authorizationMode="api-token",this.config.token=e,localStorage.setItem("frappe_api_token",e)}clearApiToken(){this.config.authorizationMode="csrf-token",this.config.token=void 0,localStorage.removeItem("frappe_api_token")}getDocTypeMeta(e){let t="/api/method/frappe.desk.form.load.getdoctype",r=new u().set("doctype",e).set("with_parent","1");return this.http.get(this.buildUrl(t),{headers:this.getAuthHeaders(),params:r}).pipe(c(s=>this.handleError(s)))}static \u0275fac=function(t){return new(t||h)(b(T))};static \u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})};export{_ as a};
