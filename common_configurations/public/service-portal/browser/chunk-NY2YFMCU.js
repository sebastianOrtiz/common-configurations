import{Ca as b,Da as d,Ea as v,d as f,e as c,i as g,k as u,q as m,t as y}from"./chunk-T6CG4JNB.js";var T={authorizationMode:"csrf-token"},o=new Map,A=class l{constructor(e){this.http=e;this.loadConfig()}config=T;loadConfig(){let e=localStorage.getItem("frappe_api_token");e&&(this.config.authorizationMode="api-token",this.config.token=e)}getAuthHeaders(){let e=new b({"Content-Type":"application/json",Accept:"application/json"});if(this.config.authorizationMode==="api-token"&&this.config.token)e=e.set("Authorization",`Basic ${this.config.token}`);else{let t=this.getCsrfToken();t&&(e=e.set("X-Frappe-CSRF-Token",t))}return e}getCsrfToken(){let e=window.csrf_token;if(e)return e;let t=document.cookie.split(";");for(let r of t){let[s,i]=r.trim().split("=");if(s==="csrf_token")return decodeURIComponent(i)}return""}getCacheKey(e,t,r){let s=r?JSON.stringify(r):"";return`${e}:${t}:${s}`}extractServerMessage(e){if(e._server_messages)try{let t=JSON.parse(e._server_messages);if(Array.isArray(t)&&t.length>0)return JSON.parse(t[0]).message}catch{}}get(e,t,r=!1){let s=new d;t&&Object.keys(t).forEach(p=>{t[p]!==null&&t[p]!==void 0&&(s=s.set(p,String(t[p])))});let i=this.buildUrl(e),n=s.toString()?`${i}?${s.toString()}`:i,a=this.getCacheKey("GET",n);if(!r&&o.has(a))return console.log(`[Frappe API] Reusing pending GET request: ${e}`),o.get(a);let h=this.http.get(i,{headers:this.getAuthHeaders(),params:s}).pipe(c(p=>this.normalizeResponse(p)),g(p=>this.handleError(p)),u(1));return r||(o.set(a,h),h.subscribe({complete:()=>o.delete(a),error:()=>o.delete(a)})),h}post(e,t,r=!1){let s=this.buildUrl(e),i=this.getCacheKey("POST",s,t);if(!r&&o.has(i))return console.log(`[Frappe API] Reusing pending POST request: ${e}`),o.get(i);let n=this.http.post(s,t,{headers:this.getAuthHeaders()}).pipe(c(a=>this.normalizeResponse(a)),g(a=>this.handleError(a)),u(1));return r||(o.set(i,n),n.subscribe({complete:()=>o.delete(i),error:()=>o.delete(i)})),n}put(e,t){let r=this.buildUrl(e);return this.http.put(r,t,{headers:this.getAuthHeaders()}).pipe(c(s=>this.normalizeResponse(s)),g(s=>this.handleError(s)))}delete(e){let t=this.buildUrl(e);return this.http.delete(t,{headers:this.getAuthHeaders()}).pipe(c(r=>this.normalizeResponse(r)),g(r=>this.handleError(r)))}callMethod(e,t){let r=`/api/method/${e}`;return this.post(r,t,!0)}getDoc(e,t){return this.get(`/api/resource/${e}/${t}`)}getList(e,t,r,s=0,i=20){let n={};return t&&(n.filters=JSON.stringify(t)),r&&r.length&&(n.fields=JSON.stringify(r)),n.limit_start=s,n.limit_page_length=i,this.get(`/api/resource/${e}`,n)}createDoc(e,t){return this.post(`/api/resource/${e}`,t,!0)}updateDoc(e,t,r){return this.put(`/api/resource/${e}/${t}`,r)}deleteDoc(e,t){return this.delete(`/api/resource/${e}/${t}`)}login(e,t){return this.post("/api/method/login",{usr:e,pwd:t},!0)}logout(){return this.post("/api/method/logout",{},!0)}getCurrentUser(){return this.get("/api/method/frappe.auth.get_logged_user")}buildUrl(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/")?e:`/${e}`}normalizeResponse(e){let t={success:!e.exc&&!e.error,message:e.message,data:e.message||e.data};if(!t.success&&e._server_messages){let r=this.extractServerMessage(e);r&&(t.error=r)}return e.exc&&(t.error=e.exc,t.exc=e.exc),e.error_code&&(t.error_code=e.error_code),t}handleError(e){console.error("[Frappe API Error]",e);let t={success:!1,error:e.error?.message||e.message||"Unknown error occurred"};if(e.error){if(e.error._server_messages){let r=this.extractServerMessage(e.error);r&&(t.error=r)}e.error.exc&&(t.exc=e.error.exc)}return f(t)}setApiToken(e){this.config.authorizationMode="api-token",this.config.token=e,localStorage.setItem("frappe_api_token",e)}clearApiToken(){this.config.authorizationMode="csrf-token",this.config.token=void 0,localStorage.removeItem("frappe_api_token")}getDocTypeMeta(e){let t="/api/method/frappe.desk.form.load.getdoctype",r=new d().set("doctype",e).set("with_parent","1");return this.http.get(this.buildUrl(t),{headers:this.getAuthHeaders(),params:r}).pipe(c(s=>this.normalizeResponse(s)),g(s=>this.handleError(s)))}static \u0275fac=function(t){return new(t||l)(y(v))};static \u0275prov=m({token:l,factory:l.\u0275fac,providedIn:"root"})};export{A as a};
