import{Aa as A,b as v,c as b,d,f as p,h as m,l as h,o as y,ra as u,x as g,ya as _,za as S}from"./chunk-HCJ7C2DO.js";var C=class c{currentUserSignal=g(null);isAuthenticatedSignal=g(!1);selectedPortalSignal=g(null);userContactSignal=g(null);isLoadingSignal=g(!1);globalErrorSignal=g(null);currentUser=this.currentUserSignal.asReadonly();isAuthenticated=this.isAuthenticatedSignal.asReadonly();selectedPortal=this.selectedPortalSignal.asReadonly();userContact=this.userContactSignal.asReadonly();isLoading=this.isLoadingSignal.asReadonly();globalError=this.globalErrorSignal.asReadonly();isPortalSelected=u(()=>this.selectedPortalSignal()!==null);hasUserContact=u(()=>this.userContactSignal()!==null);needsContactRegistration=u(()=>{let e=this.selectedPortalSignal(),t=this.userContactSignal();return e?.request_contact_user_data&&!t});state=u(()=>({currentUser:this.currentUserSignal(),isAuthenticated:this.isAuthenticatedSignal(),selectedPortal:this.selectedPortalSignal(),userContact:this.userContactSignal(),isLoading:this.isLoadingSignal(),globalError:this.globalErrorSignal()}));constructor(){this.loadPersistedState()}setCurrentUser(e){this.currentUserSignal.set(e),this.isAuthenticatedSignal.set(!!e),e?localStorage.setItem("sp_current_user",JSON.stringify(e)):localStorage.removeItem("sp_current_user")}clearAuth(){this.currentUserSignal.set(null),this.isAuthenticatedSignal.set(!1),localStorage.removeItem("sp_current_user")}setSelectedPortal(e){this.selectedPortalSignal.set(e),e?localStorage.setItem("sp_selected_portal",JSON.stringify(e)):localStorage.removeItem("sp_selected_portal")}clearPortal(){this.selectedPortalSignal.set(null),localStorage.removeItem("sp_selected_portal")}setUserContact(e){this.userContactSignal.set(e),e?localStorage.setItem("sp_user_contact",JSON.stringify(e)):localStorage.removeItem("sp_user_contact")}clearUserContact(){this.userContactSignal.set(null),localStorage.removeItem("sp_user_contact")}setLoading(e){this.isLoadingSignal.set(e)}setGlobalError(e){this.globalErrorSignal.set(e)}clearGlobalError(){this.globalErrorSignal.set(null)}resetState(){this.clearAuth(),this.clearPortal(),this.clearUserContact(),this.clearGlobalError(),this.setLoading(!1)}loadPersistedState(){try{let e=localStorage.getItem("sp_current_user");if(e){let s=JSON.parse(e);this.currentUserSignal.set(s),this.isAuthenticatedSignal.set(!0)}let t=localStorage.getItem("sp_selected_portal");if(t){let s=JSON.parse(t);this.selectedPortalSignal.set(s)}let r=localStorage.getItem("sp_user_contact");if(r){let s=JSON.parse(r);this.userContactSignal.set(s)}}catch(e){console.error("Error loading persisted state:",e),localStorage.removeItem("sp_current_user"),localStorage.removeItem("sp_selected_portal"),localStorage.removeItem("sp_user_contact")}}clearPersistedState(){localStorage.removeItem("sp_current_user"),localStorage.removeItem("sp_selected_portal"),localStorage.removeItem("sp_user_contact")}static \u0275fac=function(t){return new(t||c)};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};var T={authorizationMode:"csrf-token"},o=new Map,U=class c{constructor(e){this.http=e;this.loadConfig()}config=T;loadConfig(){let e=localStorage.getItem("frappe_api_token");e&&(this.config.authorizationMode="api-token",this.config.token=e)}getAuthHeaders(){let e=new _({"Content-Type":"application/json",Accept:"application/json"});if(this.config.authorizationMode==="api-token"&&this.config.token)e=e.set("Authorization",`Basic ${this.config.token}`);else{let t=this.getCsrfToken();t&&(e=e.set("X-Frappe-CSRF-Token",t))}return e}getCsrfToken(){let e=window.frappe;if(e&&e.csrf_token)return e.csrf_token;let t=window.csrf_token;if(t)return t;let r=document.cookie.split(";");for(let s of r){let[a,n]=s.trim().split("=");if(a==="csrf_token")return decodeURIComponent(n)}return""}fetchCsrfToken(){return v(fetch("/api/method/common_configurations.api.portal_api.get_csrf_token",{method:"GET",credentials:"same-origin",headers:{Accept:"application/json"}}).then(e=>e.json()).then(e=>{if(e&&e.message){let t=e.message;return window.frappe||(window.frappe={}),window.frappe.csrf_token=t,t}return""}).catch(()=>""))}getCacheKey(e,t,r){let s=r?JSON.stringify(r):"";return`${e}:${t}:${s}`}extractServerMessage(e){if(e._server_messages)try{let t=JSON.parse(e._server_messages);if(Array.isArray(t)&&t.length>0)return JSON.parse(t[0]).message}catch{}}get(e,t,r=!1){let s=new S;t&&Object.keys(t).forEach(l=>{t[l]!==null&&t[l]!==void 0&&(s=s.set(l,String(t[l])))});let a=this.buildUrl(e),n=s.toString()?`${a}?${s.toString()}`:a,i=this.getCacheKey("GET",n);if(!r&&o.has(i))return o.get(i);let f=this.http.get(a,{headers:this.getAuthHeaders(),params:s}).pipe(d(l=>this.normalizeResponse(l)),p(l=>this.handleError(l)),m(1));return r||(o.set(i,f),f.subscribe({complete:()=>o.delete(i),error:()=>o.delete(i)})),f}post(e,t,r=!1){let s=this.buildUrl(e),a=this.getCacheKey("POST",s,t);if(!r&&o.has(a))return o.get(a);let n=this.http.post(s,t,{headers:this.getAuthHeaders()}).pipe(d(i=>this.normalizeResponse(i)),p(i=>this.handleError(i)),m(1));return r||(o.set(a,n),n.subscribe({complete:()=>o.delete(a),error:()=>o.delete(a)})),n}put(e,t){let r=this.buildUrl(e);return this.http.put(r,t,{headers:this.getAuthHeaders()}).pipe(d(s=>this.normalizeResponse(s)),p(s=>this.handleError(s)))}delete(e){let t=this.buildUrl(e);return this.http.delete(t,{headers:this.getAuthHeaders()}).pipe(d(r=>this.normalizeResponse(r)),p(r=>this.handleError(r)))}callMethod(e,t,r=!1){let s=`/api/method/${e}`;return r?this.get(s,t,!0):this.post(s,t,!0)}getDoc(e,t){return this.get(`/api/resource/${e}/${t}`)}getList(e,t,r,s=0,a=20){let n={};return t&&(n.filters=JSON.stringify(t)),r&&r.length&&(n.fields=JSON.stringify(r)),n.limit_start=s,n.limit_page_length=a,this.get(`/api/resource/${e}`,n)}createDoc(e,t){return this.post(`/api/resource/${e}`,t,!0)}updateDoc(e,t,r){return this.put(`/api/resource/${e}/${t}`,r)}deleteDoc(e,t){return this.delete(`/api/resource/${e}/${t}`)}login(e,t){return this.post("/api/method/login",{usr:e,pwd:t},!0)}logout(){return this.post("/api/method/logout",{},!0)}getCurrentUser(){return this.get("/api/method/frappe.auth.get_logged_user")}buildUrl(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/")?e:`/${e}`}normalizeResponse(e){let t={success:!e.exc&&!e.error,message:e.message,data:e.message||e.data};if(!t.success&&e._server_messages){let r=this.extractServerMessage(e);r&&(t.error=r)}return e.exc&&(t.error=e.exc,t.exc=e.exc),e.error_code&&(t.error_code=e.error_code),t}handleError(e){console.error("[Frappe API Error]",e);let t={success:!1,error:e.error?.message||e.message||"Unknown error occurred"};if(e.error){if(e.error._server_messages){let r=this.extractServerMessage(e.error);r&&(t.error=r)}e.error.exc&&(t.exc=e.error.exc)}return b(t)}setApiToken(e){this.config.authorizationMode="api-token",this.config.token=e,localStorage.setItem("frappe_api_token",e)}clearApiToken(){this.config.authorizationMode="csrf-token",this.config.token=void 0,localStorage.removeItem("frappe_api_token")}getDocTypeMeta(e){let t="/api/method/frappe.desk.form.load.getdoctype",r=new S().set("doctype",e).set("with_parent","1");return this.http.get(this.buildUrl(t),{headers:this.getAuthHeaders(),params:r}).pipe(p(s=>this.handleError(s)))}static \u0275fac=function(t){return new(t||c)(y(A))};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};export{U as a,C as b};
