import{b as d,c as m,d as g,g as p,h as u,l as b,o as y,xa as T,ya as f,za as k}from"./chunk-JFEUYR63.js";var _="X-User-Contact-Token",A={authorizationMode:"csrf-token"},i=new Map,v=class l{constructor(e){this.http=e;this.loadConfig()}config=A;loadConfig(){let e=localStorage.getItem("frappe_api_token");e&&(this.config.authorizationMode="api-token",this.config.token=e);let t=localStorage.getItem("sp_auth_token");t?(this.config.userContactToken=t,console.log("[Auth Debug] Loaded token from localStorage:",t.substring(0,20)+"...")):console.log("[Auth Debug] No token found in localStorage")}getAuthHeaders(){let e=new T({"Content-Type":"application/json",Accept:"application/json"});if(this.config.authorizationMode==="api-token"&&this.config.token)e=e.set("Authorization",`Basic ${this.config.token}`);else{let t=this.getCsrfToken();t&&(e=e.set("X-Frappe-CSRF-Token",t))}return this.config.userContactToken?(e=e.set(_,this.config.userContactToken),console.log("[Auth Debug] Sending User Contact token:",this.config.userContactToken.substring(0,20)+"...")):console.log("[Auth Debug] No User Contact token in config"),e}getCsrfToken(){let e=window.frappe;if(e&&e.csrf_token)return e.csrf_token;let t=window.csrf_token;if(t)return t;let r=document.cookie.split(";");for(let s of r){let[n,o]=s.trim().split("=");if(n==="csrf_token")return decodeURIComponent(o)}return""}fetchCsrfToken(){return d(fetch("/api/method/common_configurations.api.portal_api.get_csrf_token",{method:"GET",credentials:"same-origin",headers:{Accept:"application/json"}}).then(e=>e.json()).then(e=>{if(e&&e.message){let t=e.message;return window.frappe||(window.frappe={}),window.frappe.csrf_token=t,t}return""}).catch(()=>""))}getCacheKey(e,t,r){let s=r?JSON.stringify(r):"";return`${e}:${t}:${s}`}extractServerMessage(e){if(e._server_messages)try{let t=JSON.parse(e._server_messages);if(Array.isArray(t)&&t.length>0)return JSON.parse(t[0]).message}catch{}}get(e,t,r=!1){let s=new f;t&&Object.keys(t).forEach(c=>{t[c]!==null&&t[c]!==void 0&&(s=s.set(c,String(t[c])))});let n=this.buildUrl(e),o=s.toString()?`${n}?${s.toString()}`:n,a=this.getCacheKey("GET",o);if(!r&&i.has(a))return i.get(a);let h=this.http.get(n,{headers:this.getAuthHeaders(),params:s}).pipe(g(c=>this.normalizeResponse(c)),p(c=>this.handleError(c)),u(1));return r||(i.set(a,h),h.subscribe({complete:()=>i.delete(a),error:()=>i.delete(a)})),h}post(e,t,r=!1){let s=this.buildUrl(e),n=this.getCacheKey("POST",s,t);if(!r&&i.has(n))return i.get(n);let o=this.http.post(s,t,{headers:this.getAuthHeaders()}).pipe(g(a=>this.normalizeResponse(a)),p(a=>this.handleError(a)),u(1));return r||(i.set(n,o),o.subscribe({complete:()=>i.delete(n),error:()=>i.delete(n)})),o}put(e,t){let r=this.buildUrl(e);return this.http.put(r,t,{headers:this.getAuthHeaders()}).pipe(g(s=>this.normalizeResponse(s)),p(s=>this.handleError(s)))}delete(e){let t=this.buildUrl(e);return this.http.delete(t,{headers:this.getAuthHeaders()}).pipe(g(r=>this.normalizeResponse(r)),p(r=>this.handleError(r)))}callMethod(e,t,r=!1){let s=`/api/method/${e}`;return r?this.get(s,t,!0):this.post(s,t,!0)}getDoc(e,t){return this.get(`/api/resource/${e}/${t}`)}getList(e,t,r,s=0,n=20){let o={};return t&&(o.filters=JSON.stringify(t)),r&&r.length&&(o.fields=JSON.stringify(r)),o.limit_start=s,o.limit_page_length=n,this.get(`/api/resource/${e}`,o)}createDoc(e,t){return this.post(`/api/resource/${e}`,t,!0)}updateDoc(e,t,r){return this.put(`/api/resource/${e}/${t}`,r)}deleteDoc(e,t){return this.delete(`/api/resource/${e}/${t}`)}login(e,t){return this.post("/api/method/login",{usr:e,pwd:t},!0)}logout(){return this.post("/api/method/logout",{},!0)}getCurrentUser(){return this.get("/api/method/frappe.auth.get_logged_user")}buildUrl(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/")?e:`/${e}`}normalizeResponse(e){let t={success:!e.exc&&!e.error,message:e.message,data:e.message||e.data};if(!t.success&&e._server_messages){let r=this.extractServerMessage(e);r&&(t.error=r)}return e.exc&&(t.error=e.exc,t.exc=e.exc),e.error_code&&(t.error_code=e.error_code),t}handleError(e){console.error("[Frappe API Error]",e);let t="Error desconocido";if(e.error)if(e.error._server_messages){let r=this.extractServerMessage(e.error);r&&(t=r)}else e.error.message?t=e.error.message:typeof e.error=="string"&&(t=e.error);else e.message&&(t=e.message);return m(()=>new Error(t))}setApiToken(e){this.config.authorizationMode="api-token",this.config.token=e,localStorage.setItem("frappe_api_token",e)}clearApiToken(){this.config.authorizationMode="csrf-token",this.config.token=void 0,localStorage.removeItem("frappe_api_token")}setUserContactToken(e){console.log("[Auth Debug] setUserContactToken called with:",e.substring(0,20)+"..."),this.config.userContactToken=e,localStorage.setItem("sp_auth_token",e);let t=localStorage.getItem("sp_auth_token");console.log("[Auth Debug] Token saved to localStorage:",t?t.substring(0,20)+"...":"null")}clearUserContactToken(){this.config.userContactToken=void 0,localStorage.removeItem("sp_auth_token")}getUserContactToken(){return this.config.userContactToken}getDocTypeMeta(e){let t="/api/method/frappe.desk.form.load.getdoctype",r=new f().set("doctype",e).set("with_parent","1");return this.http.get(this.buildUrl(t),{headers:this.getAuthHeaders(),params:r}).pipe(p(s=>this.handleError(s)))}static \u0275fac=function(t){return new(t||l)(y(k))};static \u0275prov=b({token:l,factory:l.\u0275fac,providedIn:"root"})};export{v as a};
